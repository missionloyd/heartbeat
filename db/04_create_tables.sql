
CREATE TABLE IF NOT EXISTS public.asset(
  id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  active BOOLEAN NOT NULL,
  name VARCHAR(255) NOT NULL,
  tree_id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  lft INTEGER NOT NULL,
  rght INTEGER NOT NULL
);


CREATE TABLE IF NOT EXISTS public.measurement_type(
  id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS public.measurement(
  id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  asset_id INTEGER NOT NULL,
  measurement_type_id INTEGER NOT NULL,
  ts timestamp without time zone default (now() at time zone 'utc'),
  is_prediction BOOLEAN NOT NULL,
  value NUMERIC NOT NULL,
  UNIQUE(asset_id, measurement_type_id, ts, is_prediction),
  FOREIGN KEY(asset_id) REFERENCES asset(id),
  FOREIGN KEY(measurement_type_id) REFERENCES measurement_type(id)
);


CREATE TABLE IF NOT EXISTS public.metadata(
  id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  asset_id INTEGER NOT NULL,
  data JSONB NOT NULL,
  FOREIGN KEY(asset_id) REFERENCES asset(id)
);

CREATE TABLE IF NOT EXISTS public.asset_geometry(
  id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  asset_id INTEGER NOT NULL,
  polygons GEOMETRY NOT NULL,
  properties JSONB NOT NULL,
  FOREIGN KEY(asset_id) REFERENCES asset(id)
);
